const MALWARE_SCAN_PATH = "/upload_document";
const SCAN_TIMEOUT_MS = 60_000;

export type MalwareScanResult =
  | { status: "clean"; info?: string }
  | { status: "infected"; info: string }
  | { status: "error"; info: string };

function filenameFromUrl(fileUrl: string): string {
  try {
    const pathname = new URL(fileUrl).pathname;
    const segment = pathname.split("/").filter(Boolean).pop();
    if (segment) return decodeURIComponent(segment);
  } catch {
    // ignore
  }
  return "upload";
}

export async function scanFileByUrl(
  fileUrl: string,
  baseUrl?: string
): Promise<MalwareScanResult> {
  const url = baseUrl ?? process.env.PYTHON_SERVICE_URL;
  if (!url) {
    return { status: "error", info: "Malware scan service not configured" };
  }

  const scanUrl = url.replace(/\/$/, "") + MALWARE_SCAN_PATH;
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), SCAN_TIMEOUT_MS);

  try {
    const fileRes = await fetch(fileUrl, { signal: controller.signal });
    if (!fileRes.ok) {
      return {
        status: "error",
        info: `Failed to fetch file: ${fileRes.status}`,
      };
    }
    const buffer = Buffer.from(await fileRes.arrayBuffer());
    const filename = filenameFromUrl(fileUrl);
    const form = new FormData();
    form.append("file", new Blob([buffer]), filename);

    const res = await fetch(scanUrl, {
      method: "POST",
      body: form,
      signal: controller.signal,
    });
    clearTimeout(timeout);

    const data = (await res.json()) as { status?: string; info?: string };
    const status = data?.status;

    if (status === "clean") {
      return { status: "clean", info: data.info };
    }
    if (status === "infected") {
      return { status: "infected", info: data.info ?? "Malware detected" };
    }
    return {
      status: "error",
      info: data?.info ?? `Scan failed (${res.status})`,
    };
  } catch (e) {
    clearTimeout(timeout);
    const message = e instanceof Error ? e.message : String(e);
    return { status: "error", info: message };
  }
}

export function isMalwareScanEnabled(): boolean {
  return Boolean(process.env.PYTHON_SERVICE_URL);
}
