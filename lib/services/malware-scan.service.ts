const MALWARE_SCAN_PATH = "/api/v1/security/scan";
const SCAN_TIMEOUT_MS = 60_000;

export type MalwareScanResult =
  | { status: "clean"; info?: string }
  | { status: "infected"; info: string }
  | { status: "error"; info: string };

export async function scanFileByUrl(
  fileUrl: string,
  baseUrl?: string
): Promise<MalwareScanResult> {
  const url = baseUrl ?? process.env.PYTHON_SERVICE_URL;
  if (!url) {
    return { status: "error", info: "Malware scan service not configured" };
  }

  const scanUrl = url.replace(/\/$/, "") + MALWARE_SCAN_PATH;
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), SCAN_TIMEOUT_MS);

  try {
    const res = await fetch(scanUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ file_url: fileUrl }),
      signal: controller.signal,
    });
    clearTimeout(timeout);

    const data = (await res.json()) as { status?: string; info?: string };
    const status = data?.status;

    if (status === "clean") {
      return { status: "clean", info: data.info };
    }
    if (status === "infected") {
      return { status: "infected", info: data.info ?? "Malware detected" };
    }
    return {
      status: "error",
      info: data?.info ?? `Scan failed (${res.status})`,
    };
  } catch (e) {
    clearTimeout(timeout);
    const message = e instanceof Error ? e.message : String(e);
    return { status: "error", info: message };
  }
}

export function isMalwareScanEnabled(): boolean {
  return Boolean(process.env.PYTHON_SERVICE_URL);
}
